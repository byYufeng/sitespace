{% extends "base.html" %}

{% block container%}
    <!-- 展示 -->
    <div id="show_articles">
    {% for article in articles %}
        <div>
            <h2>
                <a href="#" id="article_{{ article.id }}_title">{{ article.title }}</a>
            </h2>

            <p class="lead">
                <span class="glyphicon glyphicon-user"></span>
                <span id="article_{{ article.id }}_author">
                    {{ article.author }}
                </span>

                <font size=3>
                    <span>
                        &nbsp;&nbsp;<span class="glyphicon glyphicon-time"></span>
                        {{ article.publishtime }}
                    </span>
                    <span>
                        &nbsp;&nbsp;<span class="glyphicon glyphicon-list"></span>
                        <label id="article_{{ article.id }}_text_type">{{ article.text_type }}</label>
                    </span>
                    <!--
                    <span>
                        &nbsp;&nbsp;<span class="glyphicon glyphicon-list"></span>
                        <label id="article_{{ article.permission_public }}_permission">{{ article.permission_public }}</label>
                    </span>
                    -->
                    <span>
                        &nbsp;&nbsp;<span class="glyphicon glyphicon-edit"></span>
                        <a href="#" data-toggle="modal" data-target="#edit" onClick="EditArticle({{ article.id }})">编辑</a>
                    </span>
                    <span>
                        <!-- &nbsp;&nbsp;<a href="#" onClick="DeleteArticle({{ article.id }})">删除</a> -->
                        &nbsp;&nbsp;<span class="glyphicon glyphicon-trash"></span>
                        <a href="{{ url_for('blog.del_article') }}?id={{ article.id }}">删除</a>
                    </span>
                </font>
            </p>

            <div>
                <!-- 因为后面会渲染和转义 所以此处用隐藏标签保存原始文本 -->
                <!-- 如果这里的p标签改为div 则会导致编辑时卡死 暂不知道原因 -->
                <p id="article_{{ article.id }}_original_text" hidden>{{ article.text | safe }}</p>
                <div id="article_{{ article.id }}_text">
                </div>
                <p><a href="#">查看全文</a></p> 
                <hr>
            </div>
        </div/>
    {% else %}
        <em>This guy is so lazy...</em>
    {% endfor %}
    </div>

    <!-- 添加文章 -->
    <button type="button" class="btn btn-primary btn-circle btn-xl" data-toggle="modal" data-target="#edit" onClick="EditArticle(-1)">
        <i class="glyphicon glyphicon-plus"></i>
    </button>

    <!-- 模态弹出框（新建、编辑） -->
    <div class="modal fade" id="edit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width: 80%;">
            <div class="modal-content">
                <form id="article"  action="{{ url_for('blog.add_article') }}" method=post>
                    <div class="modal-header">
                        <!-- 标题 -->
                        <h4 class="modal-title form-group" id="myModalLabel">
                            <input name="title" id="article_title" class="form-control text-center" placeholder="Title" required="" autofocus="" />
                        </h4>
                    </div>
                    <div class="modal-body">
                        <!-- 1-4-4-1布局 -->
                        <div class="row form-group">
                            <input name="id" id="article_id" type="hidden" class="form-control" />
                            <textarea name="text" id="article_text" class="col-xs-4 col-xs-offset-1" style="resize:None;height:0px;padding-bottom:45%" onkeyup="compile_instant()" placeholder="{{ markdown_template }}"></textarea>
                            <!-- 文本类型 -->
                            <div class="col-xs-2" >
                                <div class="radio text-center">
                                    <div><label>
                                        <input type="radio" name="text_type" id="articleType1" value="normal">Normal
                                        &nbsp;&nbsp;&nbsp;
                                    </label></div>
                                    <div><label>
                                    </label></div>
                                    <div><label>
                                        <input type="radio" name="text_type" id="articleType2" value="markdown" checked>Markdown
                                    </label></div>
                                </div>
                            </div>
                            <div id="markdown_result" class="col-xs-4" style="border-style: solid;border-width:1px;border-color:rgb(169, 169, 169);height:0px;padding-bottom:45%"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default form-group" data-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-primary form-group" >提交更改</button>
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <!-- markdown插件和table扩展插件 -->
    <script src="/static/showdown.js"></script>
    <script src="/static/showdown-toc.js"></script>
    <script>
        // 将文档编译后展示 若为normal:将文本输入的\r\n换行符替换为html中的<br/> 若为markdown:转换成markdown结果
        // var converter = new showdown.Converter({extensions: ['table']}); // 
        var converter = new showdown.Converter({
            tables: true,  // table默认是没有边框等样式的 需后续自己加上
            extensions: [
                //"showdown-toc" //这个toc插件也不可用
        ]});
        function compile(text, text_type){
            if(text_type == 'normal'){
                //此处replace若使用正则则不能加引号，直接当做正则对象使用（算是个语法糖）
                return text.replace(/\n/g, '<br/>'); 
            }
            else {
                //var converter = new showdown.Converter();
                return converter.makeHtml(text);
            }
        }
    </script>
    <script>
        function compile_onload(article_id){
            var text = $("#article_" + article_id + "_original_text").text();
            var text_type = $("#article_" + article_id + "_text_type").text();
            document.getElementById("article_" + article_id + "_text").innerHTML = compile(text, text_type);
        }

        {% for article in articles %}
            compile_onload({{ article.id }});
        {% endfor %}
    </script>
    <script>
        // 给弹出的模态框传入原始内容
        function EditArticle(article_id){
            var title = $("#article_" + article_id + "_title").text();
            var text = $("#article_" + article_id + "_original_text").text();
            var text_type = $("#article_" + article_id + "_text_type").text();
            $("#article_id").val(article_id);
            $("#article_title").val(title);
            $("#article_text").text(text);
            if(text_type != ''){
                $("input[name='text_type'][value="+text_type+"]").attr("checked", true);
            }
            compile_instant();
        }

        // 若文档类型变化，则触发编译更新
        $('input[name="text_type"]').change(
            function() {
                compile_instant();
            }
        )

        // 即时编译模态框的文本
        function compile_instant(){
            var article_id = $("#article_id").val();
            var text = $("#article_text").val();
            var text_type = $("input[name='text_type']:checked").val();

            $("#markdown_result").html(compile(text, text_type));
        }

        function DeleteArticle(article_id){
            $.ajax({
                async:false,
                type: "post",
                url: "{{ url_for('blog.del_article') }}",
                data: {"id" : article_id},
                success:function(result){               
                }
            });
        }
    </script>


    <!-- 圆形按钮样式（添加文章） -->
    <style>
        .btn-circle {
          position: fixed; //关键

          width: 30px;
          height: 30px;
          text-align: center;
          padding: 6px 0;
          font-size: 12px;
          line-height: 1.428571429;
          border-radius: 15px;

          bottom: 90px;
          right: 50px;
        }
        .btn-circle.btn-lg {
          width: 50px;
          height: 50px;
          padding: 10px 16px;
          font-size: 18px;
          line-height: 1.33;
          border-radius: 25px;
        }
        .btn-circle.btn-xl {
          width: 70px;
          height: 70px;
          padding: 10px 16px;
          font-size: 24px;
          line-height: 1.33;
          border-radius: 35px;
        }
    </style>

{% endblock container %}
